<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>任务计划</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <header class="app-header">
        <div>
            <h1>任务计划</h1>
            <p class="subtitle">管理定时与条件触发的脚本任务</p>
        </div>
        <div style="display: flex; align-items: center; gap: 1.5em;">
            <!-- <span id="currentTime" class="muted" style="font-size:1.1em;"></span> -->
            <a href="https://github.com/RROrg/fn-apps" target="_blank" rel="noopener" id="githubLink"
                class="muted github-link">GitHub</a>
            <button id="btnRefresh" class="ghost">刷新</button>
        </div>
    </header>

    <main>
        <section class="toolbar">
            <button id="btnCreate" class="primary">新建</button>
            <button id="btnEdit">编辑</button>
            <button id="btnDelete" class="danger">删除</button>
            <button id="btnRun">立即运行</button>
            <button id="btnToggle">启用/停用</button>
            <button id="btnResults">查看结果</button>
        </section>

        <section class="table-wrapper">
            <table id="taskTable">
                <thead>
                    <tr>
                        <th>是否启动</th>
                        <th>任务名称</th>
                        <th>下次运行时间</th>
                        <th>触发类型</th>
                        <th>最新状态</th>
                        <th>账号</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div id="emptyState" class="empty hidden">暂无任务，点击“新建”开始配置。</div>
        </section>
    </main>

    <div id="taskModal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="taskModalTitle">新建任务</h2>
                <button class="ghost" data-close>&times;</button>
            </div>
            <form id="taskForm">
                <input type="hidden" name="task_id" />
                <div class="form-grid">
                    <label>
                        <span>任务名称</span>
                        <input type="text" name="name" required maxlength="64" />
                    </label>
                    <label>
                        <span>用户账号</span>
                        <div class="account-wrapper">
                            <select name="account" id="accountSelect" required></select>
                            <button type="button" id="btnReloadAccounts" class="ghost small">刷新</button>
                        </div>
                        <small id="accountStatus" class="muted account-status-text">Linux 环境仅可选择系统组的账号；Windows
                            环境默认使用当前登录账号</small>
                    </label>
                    <!-- 模板选择 -->
					<label>
						<span>任务模板</span>
						<select name="template" id="templateSelect">
							<option value="">无模板（自定义）</option>
							<option value="auto_shutdown">定时关机</option>
							<option value="clean_recycle">定时清理回收站</option>
						</select>
						<small class="muted">选择模板会自动填充任务内容</small>
					</label>
					<label>
						<span>触发方式</span>
						<select name="trigger_type" id="triggerType">
							<option value="schedule">定时</option>
							<option value="event">事件</option>
						</select>
					</label>
                    <label>
                        <span id="isActiveLabel">立即启动</span>
                        <label class="switch" for="isActiveCheckbox">
                            <input type="checkbox" id="isActiveCheckbox" name="is_active" checked
                                aria-labelledby="isActiveLabel" />
                            <span class="slider"></span>
                        </label>
                    </label>
                    <label>
                        <span>触发方式</span>
                        <select name="trigger_type" id="triggerType">
                            <option value="schedule">定时</option>
                            <option value="event">事件</option>
                        </select>
                    </label>
                </div>

                <div class="form-section" data-section="schedule">
                    <label>
                        <span>Cron 表达式</span>
                        <div class="cron-input-wrapper">
                            <input type="text" name="schedule_expression" placeholder="例如：*/5 * * * *" />
                            <button type="button" id="btnCronGenerator" class="ghost small">生成器</button>
                        </div>
                        <small>标准 5 字段 Cron，分钟 小时 日 月 周（周字段 0=周一）</small>
                    </label>
                </div>

                <div class="form-section hidden" data-section="event">
                    <label>
                        <span>事件类型</span>
                        <select name="event_type" id="eventType">
                            <option value="script">条件脚本</option>
                            <option value="system_boot">系统开机</option>
                            <option value="system_shutdown">系统关机</option>
                        </select>
                        <small>系统开/关机事件在服务启动或停止时各触发一次</small>
                    </label>
                    <div data-event-subsection="script">
                        <label>
                            <span>条件脚本（返回 0 触发）</span>
                            <textarea name="condition_script" rows="3"
                                placeholder="#!/bin/bash&#10;test -f /tmp/ready.flag"></textarea>
                        </label>
                        <label>
                            <span>检测间隔（秒）</span>
                            <input type="number" name="condition_interval" min="10" value="60" />
                        </label>
                    </div>
                </div>

                <label>
                    <span>前置任务</span>
                    <div class="pretask-wrapper">
                        <select name="pre_task_ids" id="preTaskSelect" multiple size="4"></select>
                        <button type="button" id="btnClearPreTasks" class="ghost small">全取消</button>
                    </div>
                    <small>仅当所选任务最近一次成功后才执行</small>
                </label>

                <label>
                    <span>任务内容</span>
                    <textarea name="script_body" rows="6" placeholder="#!/bin/bash&#10;echo hello" required></textarea>
                </label>

                <div class="modal-actions">
                    <button type="button" class="ghost" data-close>取消</button>
                    <button type="submit" class="primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <div id="resultModal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-content large">
            <div class="modal-header">
                <div>
                    <h2>执行结果</h2>
                    <p id="resultSubtitle" class="subtitle"></p>
                </div>
                <div class="modal-header-actions">
                    <button id="btnClearResults" class="ghost">清空</button>
                    <button class="ghost" data-close>&times;</button>
                </div>
            </div>
            <div class="result-list" id="resultList"></div>
        </div>
    </div>

    <div id="cronModal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2>Cron 生成器</h2>
                    <p class="subtitle">通过选择常见规则快速生成 Cron 表达式</p>
                </div>
                <button class="ghost" data-close>&times;</button>
            </div>
            <form id="cronForm">
                <div class="cron-field-list">
                    <div class="cron-field">
                        <label>
                            <span>分钟</span>
                            <select data-cron-field="minute">
                                <option value="*">每分钟 *</option>
                                <option value="0">整点 0</option>
                                <option value="*/5">每 5 分钟 */5</option>
                                <option value="*/10">每 10 分钟 */10</option>
                                <option value="*/15">每 15 分钟 */15</option>
                                <option value="custom">自定义</option>
                            </select>
                        </label>
                        <input type="text" class="cron-custom-input hidden" data-cron-custom="minute"
                            placeholder="例如 0,15,30,45" />
                    </div>
                    <div class="cron-field">
                        <label>
                            <span>小时</span>
                            <select data-cron-field="hour">
                                <option value="*">每小时 *</option>
                                <option value="*/2">每 2 小时 */2</option>
                                <option value="*/6">每 6 小时 */6</option>
                                <option value="*/12">每 12 小时 */12</option>
                                <option value="0">每天 0 点</option>
                                <option value="12">每天 12 点</option>
                                <option value="custom">自定义</option>
                            </select>
                        </label>
                        <input type="text" class="cron-custom-input hidden" data-cron-custom="hour"
                            placeholder="例如 0,6,12,18" />
                    </div>
                    <div class="cron-field">
                        <label>
                            <span>日期（天）</span>
                            <select data-cron-field="day">
                                <option value="*">每天 *</option>
                                <option value="1">每月 1 日</option>
                                <option value="15">每月 15 日</option>
                                <option value="1-5">每月 1-5 日</option>
                                <option value="custom">自定义</option>
                            </select>
                        </label>
                        <input type="text" class="cron-custom-input hidden" data-cron-custom="day"
                            placeholder="例如 1-5 或 1,15" />
                    </div>
                    <div class="cron-field">
                        <label>
                            <span>月份</span>
                            <select data-cron-field="month">
                                <option value="*">每月 *</option>
                                <option value="*/3">每季度 */3</option>
                                <option value="1">1 月</option>
                                <option value="6">6 月</option>
                                <option value="12">12 月</option>
                                <option value="custom">自定义</option>
                            </select>
                        </label>
                        <input type="text" class="cron-custom-input hidden" data-cron-custom="month"
                            placeholder="例如 3,6,9,12" />
                    </div>
                    <div class="cron-field">
                        <label>
                            <span>星期（0=周一，6=周日）</span>
                            <select data-cron-field="weekday">
                                <option value="*">每周 *</option>
                                <option value="0-4">工作日 0-4</option>
                                <option value="0">周一 0</option>
                                <option value="4">周五 4</option>
                                <option value="5">周六 5</option>
                                <option value="6">周日 6</option>
                                <option value="custom">自定义</option>
                            </select>
                        </label>
                        <input type="text" class="cron-custom-input hidden" data-cron-custom="weekday"
                            placeholder="例如 0,2,4" />
                    </div>
                </div>
                <div class="cron-preview">
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                        <div>
                            <span>当前表达式：</span>
                            <code id="cronPreview">* * * * *</code>
                        </div>
                    </div>
                    <div id="cronNextTimes" class="muted" style="margin-left:auto;font-size:0.95em;"></div>
                </div>
                <small class="muted">顺序：分钟 小时 日 月 周；自定义字段可使用数字、*、/、,、-，为空时默认 *</small>
                <div class="modal-actions">
                    <button type="button" class="ghost" data-close>取消</button>
                    <button type="button" id="btnApplyCron" class="primary">填入 Cron</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="toast hidden"></div>

    <script type="module" src="app.js"></script>
</body>

</html>
