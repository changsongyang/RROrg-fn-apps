<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>任务计划</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <header class="app-header">
        <div>
            <h1>任务计划</h1>
            <p class="subtitle">管理定时与条件触发的脚本任务</p>
        </div>
        <button id="btnRefresh" class="ghost">刷新</button>
    </header>

    <main>
        <section class="toolbar">
            <button id="btnCreate" class="primary">新建</button>
            <button id="btnEdit">编辑</button>
            <button id="btnDelete" class="danger">删除</button>
            <button id="btnRun">立即运行</button>
            <button id="btnToggle">启用/停用</button>
            <button id="btnResults">查看结果</button>
        </section>

        <section class="table-wrapper">
            <table id="taskTable">
                <thead>
                    <tr>
                        <th>是否启动</th>
                        <th>任务名称</th>
                        <th>下次运行时间</th>
                        <th>触发类型</th>
                        <th>最新状态</th>
                        <th>账号</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div id="emptyState" class="empty hidden">暂无任务，点击“新建”开始配置。</div>
        </section>
    </main>

    <div id="taskModal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="taskModalTitle">新建任务</h2>
                <button class="ghost" data-close>&times;</button>
            </div>
            <form id="taskForm">
                <input type="hidden" name="task_id" />
                <div class="form-grid">
                    <label>
                        <span>任务名称</span>
                        <input type="text" name="name" required maxlength="64" />
                    </label>
                    <label>
                        <span>账号</span>
                        <div class="account-wrapper">
                            <select name="account" id="accountSelect" required></select>
                            <button type="button" id="btnReloadAccounts" class="ghost small">刷新</button>
                        </div>
                        <small id="accountStatus" class="muted account-status-text">Linux 环境仅可选择系统组 0 / 1000 / 1001 的账号；Windows 环境默认使用当前登录账号</small>
                    </label>
                    <label>
                        <span>是否启动</span>
                        <label class="switch">
                            <input type="checkbox" name="is_active" checked />
                            <span class="slider"></span>
                        </label>
                    </label>
                    <label>
                        <span>触发方式</span>
                        <select name="trigger_type" id="triggerType">
                            <option value="schedule">定时</option>
                            <option value="event">事件</option>
                        </select>
                    </label>
                </div>

                <div class="form-section" data-section="schedule">
                    <label>
                        <span>Cron 表达式</span>
                        <input type="text" name="schedule_expression" placeholder="例如：*/5 * * * *" />
                        <small>标准 5 字段 Cron，分钟 小时 日 月 周</small>
                    </label>
                </div>

                <div class="form-section hidden" data-section="event">
                    <label>
                        <span>事件类型</span>
                        <select name="event_type" id="eventType">
                            <option value="script">条件脚本</option>
                            <option value="system_boot">系统开机</option>
                            <option value="system_shutdown">系统关机</option>
                        </select>
                        <small>系统开/关机事件在服务启动或停止时各触发一次</small>
                    </label>
                    <div data-event-subsection="script">
                    <label>
                        <span>条件脚本（返回 0 触发）</span>
                        <textarea name="condition_script" rows="3" placeholder="#!/bin/bash&#10;test -f /tmp/ready.flag"></textarea>
                    </label>
                    <label>
                        <span>检测间隔（秒）</span>
                        <input type="number" name="condition_interval" min="10" value="60" />
                    </label>
                    </div>
                </div>

                <label>
                    <span>前置任务</span>
                    <div class="pretask-wrapper">
                        <select name="pre_task_ids" id="preTaskSelect" multiple size="4"></select>
                        <button type="button" id="btnClearPreTasks" class="ghost small">清空</button>
                    </div>
                    <small>仅当所选任务最近一次成功后才执行</small>
                </label>

                <label>
                    <span>任务内容（脚本）</span>
                    <textarea name="script_body" rows="6" placeholder="#!/bin/bash&#10;echo hello" required></textarea>
                </label>

                <div class="modal-actions">
                    <button type="button" class="ghost" data-close>取消</button>
                    <button type="submit" class="primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <div id="resultModal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-content large">
            <div class="modal-header">
                <div>
                    <h2>执行结果</h2>
                    <p id="resultSubtitle" class="subtitle"></p>
                </div>
                <div class="modal-header-actions">
                    <button id="btnClearResults" class="ghost">清空</button>
                    <button class="ghost" data-close>&times;</button>
                </div>
            </div>
            <div class="result-list" id="resultList"></div>
        </div>
    </div>

    <div id="toast" class="toast hidden"></div>

    <script type="module" src="app.js"></script>
</body>
</html>
